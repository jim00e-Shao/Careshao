<!DOCTYPE html><html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¯æ—¥å–æ°´é€²åº¦åœ–ï¼ˆç²¾ç°¡ç‰ˆï¼‰</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;background:#ffeef5;margin:0;color:#334155;text-align:center}
    header{background:#ff85a2;color:#fff;padding:16px 10px;font-weight:700;font-size:20px}
    .card{background:#fff;margin:20px auto;padding:20px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.08);width:92%;max-width:560px}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    input[type=number],select,button{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    button{background:#4285f4;border:none;color:#fff;cursor:pointer}
    button:hover{background:#3367d6}
    .btn-danger{background:#ef4444}
    .btn-danger:hover{background:#dc2626}
    .status{font-size:12px;margin-top:6px}
    .status.ok{color:#059669}.status.warn{color:#d97706}.status.err{color:#dc2626}
    .progress-container{margin:18px 0}
    .circle{position:relative;width:220px;height:220px;border-radius:50%;background:conic-gradient(#4285f4 calc(var(--percent) * 1%), #e5e7eb 0);display:flex;align-items:center;justify-content:center;margin:auto;transition:background .6s ease}
    .circle span{position:absolute;font-size:20px;font-weight:700;color:#374151;line-height:1.3}
  </style>
</head>
<body>
  <header>æ¯æ—¥å–æ°´é€²åº¦åœ–ï¼ˆç²¾ç°¡ç‰ˆï¼‰</header>  <div class="card">
    <h2>æˆ‘çš„å–æ°´ç´€éŒ„</h2>
    <div class="row" style="margin-bottom:6px">
      <label for="goal">ä»Šæ—¥ç›®æ¨™ï¼š</label>
      <select id="goal" onchange="changeGoal()">
        <option value="1500">1500 cc</option>
        <option value="1800">1800 cc</option>
        <option value="2000" selected>2000 cc</option>
        <option value="2500">2500 cc</option>
      </select>
    </div>
    <div class="row">
      <input type="number" id="waterInput" placeholder="è¼¸å…¥å–æ°´é‡ (cc)" min="1" max="10000" />
      <button id="btnAdd" onclick="addWater()">æ–°å¢</button>
      <button id="btnReset" class="btn-danger" onclick="resetDaily()">é‡ç½®</button>
    </div>
    <div id="syncStatus" class="status warn">å°šæœªåŒæ­¥</div><div class="progress-container">
  <div class="circle" id="progressCircle" style="--percent:0"><span id="progressText">0 / 2000 cc<br/>0%</span></div>
</div>
<div id="note">åŠ æ²¹ï¼Œé‚„å·® 2000 ccï¼</div>

  </div>  <script>
    // ===== è®€å– ?api= åƒæ•¸ï¼ˆè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­ï¼‰ =====
    const params = new URLSearchParams(location.search);
    const API_URL = params.get('api') || 'https://script.google.com/macros/s/AKfycbxxxx/exec'; // â† å¯åœ¨é¦–é ä»¥ ?api= å‚³å…¥

    // LocalStorage keysï¼ˆæ²¿ç”¨æ—¢æœ‰ç´„å®šï¼Œæ–¹ä¾¿èˆ‡å…¶ä»–é åŒæ­¥ï¼‰
    const LS = { cur:'waterCurrent', goal:'waterGoal', last:'lastDate' };

    let goal = parseInt(localStorage.getItem(LS.goal)) || 2000;
    let current = parseInt(localStorage.getItem(LS.cur) || '0');

    document.getElementById('goal').value = goal;

    // ===== UI æ›´æ–° =====
    function updateProgress(){
      const percent = Math.min((current / Math.max(goal,1)) * 100, 150);
      const circle = document.getElementById('progressCircle');
      const text = document.getElementById('progressText');
      const note = document.getElementById('note');
      circle.style.setProperty('--percent', percent);
      circle.style.background = `conic-gradient(#4285f4 ${percent}%, #e5e7eb 0)`;
      text.innerHTML = `${current} / ${goal} cc<br/>${percent.toFixed(0)}%`;
      note.textContent = current >= goal ? 'æ³¨æ„ï¼Œè¶…éç›®æ¨™å•¦ ğŸ’§' : `åŠ æ²¹ï¼Œé‚„å·® ${Math.max(goal - current, 0)} ccï¼`;
    }

    function persist(){
      localStorage.setItem(LS.cur, String(current));
      localStorage.setItem(LS.goal, String(goal));
      localStorage.setItem(LS.last, new Date().toDateString());
    }

    // ===== å‹•ä½œ =====
    async function addWater(){
      const v = parseInt(document.getElementById('waterInput').value);
      if (isNaN(v) || v <= 0) return;
      current += v; persist(); updateProgress();
      document.getElementById('waterInput').value = '';
      await syncToday();
    }

    async function resetDaily(){
      current = 0; persist(); updateProgress();
      await syncToday();
    }

    function changeGoal(){
      goal = parseInt(document.getElementById('goal').value) || 2000;
      persist(); updateProgress();
      syncToday();
    }

    // ===== èˆ‡ Apps Script åŒæ­¥ï¼ˆæ¯æ—¥ä¸€åˆ— Upsertï¼‰ =====
    function todayISO(){ return new Date().toISOString().slice(0,10); }

    async function syncToday(){
      const el = document.getElementById('syncStatus');
      if (!API_URL || API_URL.includes('AKfycbxxxx')) { el.textContent = 'æœªè¨­å®š API_URLï¼ˆåƒ…æœ¬æ©Ÿå„²å­˜ï¼‰'; el.className='status warn'; return; }
      try{
        el.textContent = 'åŒæ­¥ä¸­â€¦'; el.className='status warn';
        const res = await fetch(API_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ date: todayISO(), amount: current, goal })
        });
        const j = await res.json();
        if (j && j.status === 'ok'){ el.textContent = 'å·²åŒæ­¥åˆ°é›²ç«¯ âœ…'; el.className='status ok'; }
        else { throw new Error('bad response'); }
      }catch(err){
        console.error(err);
        el.textContent = 'åŒæ­¥å¤±æ•—ï¼ˆä¿ç•™åœ¨æœ¬æ©Ÿï¼‰'; el.className='status err';
      }
    }

    // ===== é–‹é ï¼šå…ˆè®€é›²ç«¯ä»Šå¤©æ•¸æ“šï¼Œå†å¥—å›ç•«é¢ï¼ˆè‹¥ API ç„¡æ³•ä½¿ç”¨å‰‡ç”¨æœ¬æ©Ÿå€¼ï¼‰ =====
    async function loadToday(){
      const el = document.getElementById('syncStatus');
      if (!API_URL || API_URL.includes('AKfycbxxxx')){ updateProgress(); return; }
      try{
        const r = await fetch(API_URL + '?mode=today');
        const j = await r.json();
        if (j && j.status === 'ok'){
          goal = parseInt(j.goal) || goal; current = parseInt(j.amount) || 0;
          localStorage.setItem(LS.goal, String(goal));
          localStorage.setItem(LS.cur, String(current));
          localStorage.setItem(LS.last, new Date(j.date).toDateString());
          el.textContent = 'å·²å¾é›²ç«¯è¼‰å…¥ âœ…'; el.className='status ok';
        }
      }catch(err){ el.textContent = 'é›²ç«¯è¼‰å…¥å¤±æ•—ï¼ˆä½¿ç”¨æœ¬æ©Ÿè³‡æ–™ï¼‰'; el.className='status err'; }
      updateProgress();
    }

    // åˆå§‹åŒ–
    (async function init(){
      // éš”æ—¥è‡ªå‹•æ­¸é›¶ï¼ˆåƒ…æœ¬æ©Ÿåˆ¤æ–·ï¼‰
      const last = localStorage.getItem(LS.last);
      const today = new Date().toDateString();
      if (last && last !== today){ current = 0; persist(); }
      await loadToday();
    })();
  </script></body>
</html>